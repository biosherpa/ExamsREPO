---
title: "CORRECCIÓN EXAMEN"
author: "`r getwd()`" 
date: "`r format(Sys.time(),'%d/%m/%Y %H:%M')`"
output:
    html_document:
      self_contained: true
      toc: true
      toc_float: true 
      collapsed: false
---

########### BLOQUE PARA INCRUSTAR DESPUÉS DE PREGUNTAS G1/G2/G3 ########G#

# PROTOCOLO DE CORRECCIÓN 
  
  He tratado de modificar el código para que sea más automático y sencillo para ti corregir.
  En realidad verás mucho más código porque usa condicionales por si falla algún recurso, por ejemplo github, para que en su lugar cargue el mismo archivo de la carpeta compartida. Espero que para ti sea transparente, pero haremos una prueba el lunes.

  Sigue estos pasos para integrar el motor de corrección en el examen del alumno:
  
##  1. Inserción del Motor y Datos
  Nada más abrir el examen del alumno, busca la línea que dice "Pregunta G1" (o G2/G3) e inserta justo debajo el bloque de código que hay justo debajo del encabezado #CORRECCIÓN. Este chunk carga el motor desde GitHub (o OneDrive si falla internet) y prepara los datos. Al inicio del chunk verás la variable tipo que deberás cambiar acorde al grupo del alumno. Dado que este año los tres grpos tienen la misma matriz de corrección si no lo haces no pasa nada salvo que el alumno pregunte porque no coincida con su grupo.
  
## 2. Configuración del Snippet de Calificación
  
  Pueds copiar y pegar el fragmento que ya usábamos para los comentarios sobre los apartado.
  Pero he descubierto que con un  sencillo snippet, la tarea se facilita mucho.
  Para no escribir código repetitivo, configura este snippet en tu RStudio (**Tools > Global Options > Code > Edit Snippets**). Busca la sección **Markdown** y pega esto al final:
  
  Esto es lo que incrusta el snippet
  
  
	### <span style="color: red;"> Corrección.</span>
	
	- Hipótesis: 
	- Justificación: 
	- Comprobación de condiciones: 
	- Código: 
	- Interpretación de resultados: 
	
	**Comentarios:** -
	
	```{r, echo=FALSE}
	cal${1:1} <- c(10, 10, 10, 10, 10)
	```
	
	
	  Uso: Escribe cal y luego pulsa Mayús + Tab 
	  Donde estés escribiendo, insertará el texto (que luego puedes modificar) y un chunk para insertar el vector de calificación.
	  He pensado qeu, dado que es una tarea que se repite muchas veces, este automatismos te ahorrará tiempo.
  
##  3. Cierre y Evaluación Final
  
  Al final de todo el archivo .Rmd del alumno, pega el bloque debajo del epígrafe #EVALUACIÓN para generar la tabla de notas y la calificación final:
  
  No olvides cambiar el nombre al archivo de corrección para no perder el del alumno, aunque siempre se puede volver a descarar del aula virtual.
  
##  4. Compilar.

########### Lo que hay que copiar y pegar está a partir de este punto ##############

# CORRECCIÓN 

   Carga de datos para corrección a partir de la imagen.

  - Este archivo de corrección carga los datos que contienen la imagen del espacio de trabajo que subiste el día de la prueba.

  - Tendrá desactivadas las líneas de código que impidan compilar el documento de corrección.




```{r setup_correccion, include=FALSE}
 tipo <- 2


# 1. CONFIGURACIÓN DE RMARKDOWN
knitr::opts_chunk$set(
  comment = "#",
  echo = TRUE,      
  warning = FALSE,   
  message = FALSE    
)

  # 2. CARGA DE DATOS (Detección automática en la carpeta actual)
  filenameRData <- dir(pattern = "\\.RData$")
  filenameCSV   <- dir(pattern = "\\.csv$")
  
 # Definimos la ruta base común para la red de seguridad local
    user_home  <- Sys.getenv("USERPROFILE")
    path_local <- file.path(user_home, "OneDrive - Universidad Rey Juan Carlos", "BIOSTATMED_2026")
    
   if (length(filenameRData) > 0) {
        # SOLUCIÓN AL ERROR: Renombramos el archivo del alumno para quitar paréntesis/espacios
        archivo_original <- filenameRData[1]
        archivo_seguro   <- "datos_alumno_temp.RData"
        file.rename(archivo_original, archivo_seguro)
        load(file = archivo_seguro)
      } else if (length(filenameCSV) > 0) {
        datos <- read.csv(filenameCSV[1])
      } else {
      # Si no hay archivos del alumno, intentamos descargar de GitHub
      # Usamos tryCatch para que si no hay internet, pase al respaldo de OneDrive
      tryCatch({
        datos <- readRDS(url("https://github.com/biosherpa/ExamsREPO/raw/main/respaldo_vigente.rds"))
      }, error = function(e) {
        # Red de seguridad final: Datos desde OneDrive local
        path_rds_local <- file.path(path_local, "respaldo_vigente.rds")
        if (file.exists(path_rds_local)) {
          datos <<- readRDS(path_rds_local) # Usamos <<- para asegurar que suba al entorno global
        } else {
          warning("No se encontraron datos de respaldo en la nube ni en local.")
        }
      })
    }

# 3. CARGA DEL MOTOR DE CORRECCIÓN (GitHub con respaldo en OneDrive)
 
    # 3. CARGA DEL MOTOR DE CORRECCIÓN
        tryCatch({
          source(url("https://raw.githubusercontent.com/biosherpa/ExamsREPO/main/motor_activo.R"), local = TRUE)
        }, error = function(e) {
          # Respaldo desde OneDrive si falla GitHub
          path_motor_local <- file.path(path_local, "motor_activo.R")
          if (file.exists(path_motor_local)) {
            source(path_motor_local, local = TRUE)
          } else {
            stop("ERROR: No hay conexión a GitHub ni motor local en OneDrive.")
          }
        })
  
  # 4. LIBRERÍAS (Carga silenciosa)
  library(tidyverse)
  library(gt)
  library(psych)
```




  ########### BLOQUE PARA INCRUSTAR DETRÁS DE CADA PREGUNTA #########
  # más rápido configurar un snippet ##

### <span style="color: red;"> Corrección.</span>

  - Hipótesis. 
  - Justificación.
  - Comprobación de condiciones.
  - Código.
  - Interpretación de resultados.
  
  
  ########### BLOQUE PARA INCRUSTAR AL FINAL DEL EXAMEN #########
  




# EVALUACIÓN.



```{r library-eval, echo=FALSE,results='hide',include=FALSE}
library(tidyverse)
library(gt)
library(psych)
# 22/01/2025 lo saco a github para poder compartirlo con Jesús, pero coloco una red de seguridad.
# source(url("https://raw.githubusercontent.com/biosherpa/ExamsREPO/refs/heads/main/motor_activo.R"),
#        local = TRUE)
# Intentamos cargar desde GitHub (vínculo directo al RAW)
# Lógica de carga del motor: Primero GitHub, luego OneDrive local
tryCatch({
  # 1. Prioridad absoluta: GitHub
  source(url("https://raw.githubusercontent.com/biosherpa/ExamsREPO/main/motor_activo.R"), local = TRUE)
  message("✅ Motor cargado desde GitHub.")

}, error = function(e) {
  # 2. Respaldo: Buscar en OneDrive localmente
  user_home <- Sys.getenv("USERPROFILE")
  base_od   <- file.path(user_home, "OneDrive - Universidad Rey Juan Carlos")

  # Definimos las dos realidades posibles:
  path_invitado <- file.path(base_od, "2026_ene", "motor_activo.R")
  path_dueno    <- file.path(base_od, "Documents", "A_OD_Docencia", "GRADO", 
                           "MED-BIOEST", "BiostatMedicina", "2026_ene", "motor_activo.R")

  # Lógica de selección:
  if (file.exists(path_invitado)) {
    source(path_invitado, local = TRUE)
    message("⚠️ Cargado desde OneDrive (Ruta Invitado).")
  } else if (file.exists(path_dueno)) {
    source(path_dueno, local = TRUE)
    message("⚠️ Cargado desde OneDrive (Ruta Dueño).")
  } else {
    stop("❌ ERROR CRÍTICO: El motor no está en GitHub ni en ninguna ruta de OneDrive.")
  }
})


```



Como se indicaba en el texto que se os facilitó el día del examen:

**En la evaluación de esta prueba, se valora no solo el código (25%) sino también otros aspectos. En concreto, se valora que incluya las hipótesis estadísticas (20 %), la justificación de la elección del contraste o método utilizado (20%), la comprobación o justificación del cumplimiento de las condiciones para su aplicación (10 % de la pregunta) y la interpretación correcta de los resultados (25 %) para cada variable solicitada.**



Aunque depende de la pregunta, se pueden llegar a evaluar hasta 5 aspectos: 

  1. Hipótesis.
  1. Justificación.
  1. Comprobación de los supuestos.
  1. Ejecución.
  1. Interpretación del resultado.
  
  La sexta pregunta es una puntuación extra de 0.25 concedida en función de haber conseguido o no compilar el Rmd.


```{r notafin, echo=FALSE}
notafin.R() 
```

Tu examen era el modelo **<span style="color: red;">`r paste0("G",tipo)`</span>**.

Tu nota final en este ejercicio es **<span style="color: red;">`r notatot.print`</span>**.


En la siguiente tabla puedes ver qué apartado se ha juzgado en cada pregunta .

```{r matvecus, echo=FALSE}
matvecus.print %>% 
  as.data.frame %>% 
  gt::gt(rownames_to_stub = T) %>% 
   fmt(
    columns = everything(),  # Apply to all columns (or specify specific ones)
    # rows = Preguntas == "NotaFinalR",           # Condition: Replace only when value equals 0
    fns = function(x)  ifelse(is.na(x), "-", x)    # Replace 0 with "-"
  ) %>% 
  fmt(
    columns = everything(),  # Apply to all columns (or specify specific ones)
    # rows = Preguntas == "NotaFinalR",           # Condition: Replace only when value equals 0
    fns = function(x)  ifelse(x == 1, "X", x)    # Replace 0 with "-"
  ) 
```



En aquellas preguntas en las que no se valoró alguno de los apartados, el peso de los apartados ausentes se reparte entre los que sí se valoraron de manera proporcional a los pesos originales de estos últimos.

Estos los pesos (en tanto por uno) corregidos en función de si se usan o no con el reparto mencionado anteriormente.

```{r mat.pond,echo=FALSE}


mat.pond.print %>% 
  as.data.frame %>% 
  # mutate(across(.cols=everything(),.fns=~(round(.*100)))) %>% 
  gt::gt(rownames_to_stub = T) %>% 
   fmt(
    columns = everything(),  # Apply to all columns (or specify specific ones)
    # rows = Preguntas == "NotaFinalR",           # Condition: Replace only when value equals 0
    fns = function(x)  ifelse(is.na(x), "-", x)    # Replace 0 with "-"
  )  
```

  * Estas son tus puntuaciones sobre 10 de cada apartado de cada pregunta.



```{r echo=FALSE}

mat.res.uno.print %>% 
  as.data.frame %>% 
  # mutate(across(.cols=everything(),.fns=~(round(.*100)))) %>% 
  gt::gt(rownames_to_stub = T)  
  
```

Recuerda que no todas son evaluadas (ver tabla anterior), por lo que algunos "0" no se utilizarán para el cálculo de tu nota.

Y estas tus puntuaciones en cada apartado una vez ponderadas en función de los pesos corregidos. 

  * La **columna TotPreg_10** indica la puntuación obtenida en cada pregunta en escala de 10 puntos.
  * La **fila MeanPregOb_10** indica la media de puntuación obtenida en cada apartado (Hipótesis, Justificación....) transformada a una escala de 10 puntos. 
  * La **fila PExtra** indica la puntuación obtenida si conseguiste compilar el archivo Rmd y construir el html.
  * La **fila NotaFinalR** indica la suma de la media obtenida en las preguntas obligatorias (1 a 5) más la puntuación por la PExtra, con un máximo de 10 puntos.


```{r mat-res-tres, echo=FALSE}
mat.res.tres.print %>% 
  as.data.frame %>% 
  rownames_to_column(var = "Preguntas") %>% 
  # gt::gt(rownames_to_stub = T) %>% 
    gt::gt(rowname_col = "Preguntas") %>% 
  fmt(
    columns = everything(),  # Apply to all columns (or specify specific ones)
    rows = Preguntas == "NotaFinalR",           # Condition: Replace only when value equals 0
    fns = function(x)  ifelse(x == 0, "-", x)    # Replace 0 with "-"
  ) %>% 
  fmt(
    columns = everything(),  # Apply to all columns (or specify specific ones)
    # rows = Preguntas == "NotaFinalR",           # Condition: Replace only when value equals 0
    fns = function(x)  ifelse(is.na(x), "-", x)    # Replace 0 with "-"
  ) %>% 

  gt::tab_style(
    style=list(cell_text(
      color = 'red',
      weight = 'bold',
                ),
      cell_fill(color='yellow')),
    location=cells_body(
      columns = TotPreg_10,
      # rows = 6
    )
  )%>% 
  gt::tab_style(
    style=list(cell_text(
      color = 'red',
      weight = 'bold',
                ),
      cell_fill(color='green')),
    location=cells_body(
       columns = -TotPreg_10,
       rows = Preguntas == "MeanPregOb_10"
    )
  ) %>% 
  gt::tab_style(
    style=list(cell_text(
      color = 'yellow',
      weight = 'bold',
                ),
      cell_fill(color='red')),
    location=cells_body(
       columns = TotPreg_10,
       rows = TotPreg_10 <5 & Preguntas == 'NotaFinalR'
    )
  ) %>% 
  gt::tab_style(
    style=list(cell_text(
      color = 'red',
      weight = 'bold',
                ),
      cell_fill(color='skyblue')),
    location=cells_body(
       columns = TotPreg_10,
       rows = TotPreg_10 >5 & Preguntas == 'NotaFinalR'
    )
  )
  
  
```


FIN DE LA CORRECCIÓN.

```{r, echo=FALSE}
rm(list=ls(envir = .GlobalEnv))
```


